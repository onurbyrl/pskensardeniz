<!DOCTYPE html>
{% load static %}
{% load i18n %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Randevu</title>
    <meta name="description"
        content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="shortcut icon" type="image/x-icon" href="favicon.webp">

    <link rel="stylesheet" href="{% static 'css/vendor/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/vendor/slick.css' %}">
    <link rel="stylesheet" href="{% static 'css/vendor/slick-theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/sal.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/feather.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/fontawesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/euclid-circulara.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/swiper.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/magnify.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/odometer.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/animation.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/bootstrap-select.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/jquery-ui.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins/magnigy-popup.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'js/vendor/bootstrap.min.js' %}"></script>

    <script src="{% static 'js/vendor/jquery.js' %}"></script>

    <script src="{% static 'js/vue.js' %}"></script>
    <script src="http://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/css/bootstrap-timepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
        <div id="app">
            <header class="rbt-header rbt-header-9">
                {% include '../header.html' %}
                {% include '../navbar.html' %}
            </header>
            {% include '../mobile-section.html' %}
        </div>

        <div class="rbt-breadcrumb-default ptb--100 ptb_md--50 ptb_sm--30 bg-gradient-1">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="breadcrumb-inner text-center">
                            <h2 class="title">{% trans "Randevu OluÅŸtur" %}</h2>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-5">
            {% if user.is_authenticated %}
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">ðŸ“… {% trans "Randevu OluÅŸtur" %}</h3>

                    
        
                    <form id="appointmentForm" method="POST" action="{% url 'users:randevu_olustur' %}">
                        {% csrf_token %}

                        <!-- Ãœlke SeÃ§imi -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">{% trans "BulunduÄŸunuz Ãœlke / Åžehir" %}:</label>
                            <select id="timezone-select" name="timezone" class="form-control">
                                <option value="Europe/Istanbul">ðŸ‡¹ðŸ‡· TÃ¼rkiye (Ä°stanbul)</option>
                                <option value="Europe/London">ðŸ‡¬ðŸ‡§ Ä°ngiltere (Londra)</option>
                                <option value="America/New_York">ðŸ‡ºðŸ‡¸ ABD (New York)</option>
                                <option value="Asia/Tokyo">ðŸ‡¯ðŸ‡µ Japonya (Tokyo)</option>
                                <option value="Australia/Sydney">ðŸ‡¦ðŸ‡º Avustralya (Sydney)</option>
                                <option value="Europe/Berlin">ðŸ‡©ðŸ‡ª Almanya (Berlin)</option>
                                <option value="Europe/Paris">ðŸ‡«ðŸ‡· Fransa (Paris)</option>
                                <option value="Europe/Moscow">ðŸ‡·ðŸ‡º Rusya (Moskova)</option>
                                <option value="America/Toronto">ðŸ‡¨ðŸ‡¦ Kanada (Toronto)</option>
                                <option value="Pacific/Auckland">ðŸ‡³ðŸ‡¿ Yeni Zelanda (Auckland)</option>
                                <!-- Ãœlke sayÄ±sÄ± artÄ±rÄ±labilir -->
                            </select>
                        </div>
                        
                        <!-- Tarih SeÃ§imi -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">{% trans "Tarih SeÃ§in" %}:</label>
                            <input type="text" id="appointment_date" name="date" class="form-control datepicker" required>
                        </div>
        
                        <!-- Saat SeÃ§imi -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">{% trans "Saat SeÃ§in" %}:</label>
                            <input type="text" id="appointment_time" name="time" class="form-control timepicker" required>
                        </div>
        
                        <!-- Not AlanÄ± -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">{% trans "Ek Notlar (opsiyonel)" %}:</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Randevu hakkÄ±nda eklemek istediÄŸiniz notlar..."></textarea>
                        </div>
        
                        <!-- Butonlar -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary px-4 btn-lg">
                                <i class="fas fa-calendar-check"></i> {% trans "Randevu OluÅŸtur" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <h3>{% trans "Randevu oluÅŸturmak iÃ§in giriÅŸ yapÄ±n." %}</h3>
            <br>
            <a href="{% url 'users:login' %}" class="btn btn-primary btn-lg">GiriÅŸ Yap</a>
            {% endif %}
        </div>

        <!-- Start Footer aera -->
        <div class="mt-5">
            {% include '../footer.html' %}
        </div>
        <!-- End Footer aera -->
    </div>
</body>

<!-- Gerekli JavaScript KÃ¼tÃ¼phaneleri -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

<script>
    
</script>

<script>
    const { DateTime } = luxon;

    let selectedZone = "Europe/Istanbul";  // default zaman dilimi

    // Flatpickrâ€™Ä± gÃ¼ncellemek iÃ§in yeniden baÅŸlatmak gerekiyor
    function updateTimePicker(zone) {
        const nowInZone = DateTime.now().setZone(zone);
        $("#appointment_time").flatpickr().destroy(); // var olanÄ± sil

        $("#appointment_time").flatpickr({
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            defaultDate: nowInZone.toFormat("HH:00"),
            time_24hr: true,
            minuteIncrement: 60
        });
    }

    $(document).ready(function () {
        // Tarih iÃ§in dÃ¼z ayar
        $("#appointment_date").flatpickr({
            dateFormat: "Y-m-d",
            minDate: new Date().fp_incr(7),
            disableMobile: true
        });

        // Ä°lk saat seÃ§ici baÅŸlat
        updateTimePicker(selectedZone);

        // Zaman dilimi deÄŸiÅŸince saat giriÅŸini gÃ¼ncelle
        $("#timezone-select").on("change", function () {
            selectedZone = this.value;
            updateTimePicker(selectedZone);
        });
    });
</script>


<script>
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Ã‡erez ismini kontrol et
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    const csrfToken = getCookie("csrftoken");

    document.getElementById('AppointmentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const formData = {
            date: document.querySelector('[name="date"]').value,
            time: document.querySelector('[name="time"]').value,
            notes: document.querySelector('[name="notes"]').value,
            timezone: document.querySelector('[name="timezone"]').value
        };

        fetch("{% url 'users:randevu_olustur' %}", {
            method: "POST",
            headers: {
                'Content-Type': 'intervention/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())  // JSON formatÄ±nda yanÄ±tÄ± iÅŸle
        .then(data => {
            console.log("Response Data: ", data);
            if (data.status === "success") {
                Swal.fire({
                    icon: "success",
                    title: "Randevunuz baÅŸarÄ±yla oluÅŸturuldu",
                    text: data.message,
                    timer: 4000,
                    showConfirmButton: false
                }).then(() => {
                    // window.location.href = data.redirect_url;
                });
            } else if (data.status === "error") {
                Swal.fire({
                    icon: "error",
                    title: "Hata!",
                    test: data.message,
                    timer: 6000,
                    showConfirmButton: false
                })
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Hata!",
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error("ERR: ", error);
            Swal.fire({
                icon: "error",
                title: "Sunucu HatasÄ±",
                text: "Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin."
            });
        });
    });
</script>

</html>